import{w as h,d as f}from"./ChdA8jD2.js";import{A as d}from"./CKvi8eoo.js";function m(){const{subscribe:l,set:u,update:i}=h({user:null,token:localStorage.getItem("token"),isAuthenticated:!1});return{subscribe:l,login:async(t,s)=>{const e=new FormData;e.append("username",t),e.append("password",s);const a=await fetch(`${d}/api/auth/login`,{method:"POST",body:e});if(!a.ok)throw new Error("Invalid credentials");const n=await a.json();localStorage.setItem("token",n.access_token),i(r=>({...r,token:n.access_token,isAuthenticated:!0}));const o=await(await fetch(`${d}/api/auth/me`,{headers:{Authorization:`Bearer ${n.access_token}`}})).json();return i(r=>({...r,user:o})),o},logout:()=>{localStorage.removeItem("token"),u({user:null,token:null,isAuthenticated:!1})},checkAuth:async()=>{const t=localStorage.getItem("token");if(!t)return!1;try{const s=await fetch(`${d}/api/auth/me`,{headers:{Authorization:`Bearer ${t}`}});if(!s.ok)throw new Error("Token invalid");const e=await s.json();return u({user:e,token:t,isAuthenticated:!0}),!0}catch{return localStorage.removeItem("token"),u({user:null,token:null,isAuthenticated:!1}),!1}}}}const g=m();function S(){const{subscribe:l,set:u,update:i}=h([]);let t=null;g.subscribe(e=>{t=e.token});const s=()=>({"Content-Type":"application/json",Authorization:`Bearer ${t}`});return{subscribe:l,load:async(e={})=>{const a=new URLSearchParams;Object.entries(e).forEach(([o,r])=>{r&&a.append(o,r)});const c=await(await fetch(`${d}/api/tasks/?${a}`,{headers:s()})).json();return u(c),c},create:async e=>{const a=await fetch(`${d}/api/tasks/`,{method:"POST",headers:s(),body:JSON.stringify(e)});if(!a.ok){const c=await a.json();throw new Error(c.detail||"Ошибка создания задачи")}const n=await a.json();return i(c=>[...c,n]),n},updateTask:async(e,a)=>{const c=await(await fetch(`${d}/api/tasks/${e}`,{method:"PATCH",headers:s(),body:JSON.stringify(a)})).json();return i(o=>o.map(r=>r.id===e?c:r)),c},changeStatus:async(e,a,n=null,c={})=>{const o=await fetch(`${d}/api/tasks/${e}/status`,{method:"PATCH",headers:s(),body:JSON.stringify({status:a,comment:n,...c})});if(!o.ok){const p=await o.json();throw new Error(p.detail||"Ошибка изменения статуса")}const r=await o.json();return i(p=>p.map(w=>w.id===e?r:w)),r},undo:async e=>{const n=await(await fetch(`${d}/api/tasks/${e}/undo`,{method:"POST",headers:s()})).json();return i(c=>c.map(o=>o.id===e?n:o)),n},take:async e=>{const n=await(await fetch(`${d}/api/tasks/${e}/take`,{method:"POST",headers:s()})).json();return i(c=>c.map(o=>o.id===e?n:o)),n},delete:async e=>{await fetch(`${d}/api/tasks/${e}`,{method:"DELETE",headers:s()}),i(a=>a.filter(n=>n.id!==e))}}}const k=S(),$=f(k,l=>{const u={new:[],in_progress:[],editor_review:[],client_approval:[],client_approved:[],sent_to_media:[],published:[],postponed:[]};l.forEach(s=>{u[s.status]&&u[s.status].push(s)});const i=new Date,t=new Date(i.getTime()-3*24*60*60*1e3);return Object.keys(u).forEach(s=>{u[s].sort((e,a)=>{const n=new Date(e.status_changed_at)<t,c=new Date(a.status_changed_at)<t;return n&&!c?-1:!n&&c?1:new Date(e.status_changed_at)-new Date(a.status_changed_at)})}),u});function b(){const{subscribe:l,set:u,update:i}=h({connected:!1,reconnecting:!1});let t=null,s=null;const e=()=>{const o=window.location.protocol==="https:"?"wss:":"ws:";t=new WebSocket(`${o}//${window.location.host}/api/ws/board`),t.onopen=()=>{i(r=>({...r,connected:!0,reconnecting:!1})),console.log("WebSocket connected")},t.onclose=()=>{i(r=>({...r,connected:!1})),console.log("WebSocket disconnected"),s=setTimeout(()=>{i(r=>({...r,reconnecting:!0})),e()},3e3)},t.onerror=r=>{console.error("WebSocket error:",r)},t.onmessage=r=>{const p=JSON.parse(r.data);a(p)}},a=o=>{switch(o.type){case"task_created":case"task_updated":case"task_status_changed":case"task_taken":case"task_undo":k.load();break}};return{subscribe:l,connect:e,disconnect:()=>{s&&clearTimeout(s),t&&t.close()},send:o=>{t&&t.readyState===WebSocket.OPEN&&t.send(JSON.stringify(o))}}}const A=b();export{g as a,$ as b,k as t,A as w};
